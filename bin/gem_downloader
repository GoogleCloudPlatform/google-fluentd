#!/usr/bin/env ruby

require 'fileutils'
$LOAD_PATH << File.expand_path(File.join(File.dirname(__FILE__), '..', 'lib'))
require 'gems_parser'

if ARGV.empty?
  puts "Invalid usage!"
  puts "./bin/gem_downloader gems.rb"
  exit 0
end

gp = GemsParser.parse(File.read(ARGV[0]))
index = 0
file_format = "%0#{(gp.target_files.length - 1).to_s.length}d-%s-%s.gem"

FileUtils.remove_dir(gp.target_dir, true)
Dir.mkdir(gp.target_dir)
Dir.chdir(gp.target_dir) {
  gp.target_files.each { |n, v, an|
    path = sprintf(file_format, index, n, v)
    loop {
      if v == 'latest'
        output = `gem fetch #{n} --platform ruby`.strip.split(' ')
        fail 'Unexpected output: #{output}' unless output[0] == 'Downloaded'
        fail 'Unexpected output: #{output}' unless output.size == 2
        downloaded_gem_path = "#{output[1]}.gem"
        # Extract the gem's version from the output `gem fetch`.
        # E.g., extract "1.8.7" from "Downloaded grpc-1.8.7".
        actual_version = output[1].dup
        if actual_version.slice!("#{n}-").nil?
          fail "Unexpected gem name: #{actual_version}"
        end
        path = sprintf(file_format, index, n, actual_version)
        `mv #{downloaded_gem_path} #{path}`
      else
        `curl -o #{path} -L http://rubygems.org/downloads/#{n}-#{v}.gem`
      end
      `gem install --explain #{path} --no-ri --no-rdoc`
      break if $?.success?
      sleep 1
    }
    index += 1
  }
}
